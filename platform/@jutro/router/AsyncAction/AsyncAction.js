import _extends from"@babel/runtime-corejs3/helpers/extends";import _objectWithoutProperties from"@babel/runtime-corejs3/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime-corejs3/helpers/classCallCheck";import _createClass from"@babel/runtime-corejs3/helpers/createClass";import _assertThisInitialized from"@babel/runtime-corejs3/helpers/assertThisInitialized";import _inherits from"@babel/runtime-corejs3/helpers/inherits";import _possibleConstructorReturn from"@babel/runtime-corejs3/helpers/possibleConstructorReturn";import _getPrototypeOf from"@babel/runtime-corejs3/helpers/getPrototypeOf";import _defineProperty from"@babel/runtime-corejs3/helpers/defineProperty";function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}import React,{Component}from"react";import PropTypes from"prop-types";import{withRouter}from"react-router-dom";import isObject from"lodash/isObject";import omit from"lodash/omit";import cx from"classnames";import{InlineLoader,withModalContext}from"@jutro/components";import{intlMessageShape,intlToShape,IntlToShape}from"@jutro/prop-types";import{isPromise}from"@jutro/platform";import{TranslatorContext,getUrlTranslatorAndSanitizer}from"@jutro/locale";import styles from"./AsyncAction.module.css";import{handleAction}from"../actionHelper";export const propTypes={failTo:intlToShape,failToMessage:PropTypes.string,message:intlMessageShape,replace:PropTypes.bool,to:intlToShape,toMessage:PropTypes.string,onTrigger:PropTypes.func.isRequired,onClick:PropTypes.func,allowNoLeadingSlash:PropTypes.bool};const defaultProps={replace:!1,allowNoLeadingSlash:!1};export const withAsyncAction=WrappedComponent=>{var _class,_temp;const AsyncAction=(_temp=_class=function(_Component){_inherits(AsyncAction,Component);var _super=_createSuper(AsyncAction);function AsyncAction(...args){var _this,instance;return _classCallCheck(this,AsyncAction),_this=_super.call(this,...args),_defineProperty(_assertThisInitialized(_this),"state",{loading:!1}),_defineProperty(_assertThisInitialized(_this),"translator",_this.context),_defineProperty(_assertThisInitialized(_this),"urlTranslatorAndSanitizer",getUrlTranslatorAndSanitizer(_this.context)),_defineProperty(_assertThisInitialized(_this),"handleClick",(instance=_assertThisInitialized(_this),event=>{const _instance$props=instance.props,onClick=_instance$props.onClick,target=_instance$props.target,allowNoLeadingSlash=_instance$props.allowNoLeadingSlash,modalContext=_instance$props.modalContext;if(onClick&&onClick(event),!(event.defaultPrevented||void 0!==event.button&&0!==event.button||target)){if(event.preventDefault(),instance.state.loading)return;const _instance$props2=instance.props,onTrigger=_instance$props2.onTrigger,to=_instance$props2.to,failTo=_instance$props2.failTo,message=_instance$props2.message,toMessage=_instance$props2.toMessage,failToMessage=_instance$props2.failToMessage,translator=instance.translator,urlTranslatorAndSanitizer=instance.urlTranslatorAndSanitizer;let resultException,result=!1;try{result=onTrigger()}catch(ex){resultException=ex}const actionObject=isObject(result)&&!isPromise(result)?result:{name:"unknown",result:result,resultException:resultException},translatedTo=urlTranslatorAndSanitizer(to,allowNoLeadingSlash),translatedFailTo=urlTranslatorAndSanitizer(failTo,allowNoLeadingSlash);Object.entries({progress:{message:message},success:{path:translatedTo,message:toMessage},failure:{path:translatedFailTo,message:failToMessage}}).forEach((([key,value])=>{actionObject[key]||(actionObject[key]=value)})),handleAction(actionObject,instance,translator,modalContext)}})),_defineProperty(_assertThisInitialized(_this),"renderContent",(()=>{const children=_this.props.children;return _this.state.loading?React.createElement(React.Fragment,null,React.createElement("div",{className:styles.underLoader},_this.translator(children)),_this.renderLoaderContent()):children})),_this}return _createClass(AsyncAction,[{key:"renderLoaderContent",value:function(){const message=this.state.message||this.props.message,loading=this.state.loading;if(!message)return React.createElement(InlineLoader,{loading:loading,className:styles.loaderOnly});const ellipsisClasses=[null,styles.ellipsisSecondDot,styles.ellipsisThirdDot].map((specificClassName=>cx(styles.ellipsis,specificClassName)));return React.createElement("div",{className:styles.loader,role:"alert"},`${this.translator(message)} `,ellipsisClasses.map(((dotClassName,index)=>React.createElement("span",{key:index,className:dotClassName},"."))))}},{key:"render",value:function(){const _omit=omit(this.props,["translator","allowNoLeadingSlash","toMessage","failTo","failToMessage"]),props=(_omit.children,_omit.staticContext,_omit.replace,_omit.modalContext,_objectWithoutProperties(_omit,["children","staticContext","replace","modalContext"])),loading=(this.state||this.props).loading;return React.createElement(WrappedComponent,_extends({},props,{onClick:this.handleClick,loading:loading}),this.renderContent())}}]),AsyncAction}(),_defineProperty(_class,"propTypes",{...propTypes,...WrappedComponent.propTypes}),_defineProperty(_class,"defaultProps",{...defaultProps,...WrappedComponent.defaultProps}),_defineProperty(_class,"contextType",TranslatorContext),_temp),wrapped=withRouter(withModalContext(AsyncAction));return wrapped.displayName=WrappedComponent.displayName||WrappedComponent.name||"Component",wrapped.WrappedComponent=WrappedComponent,wrapped};