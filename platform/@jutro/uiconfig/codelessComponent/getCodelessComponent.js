import _extends from"@babel/runtime-corejs3/helpers/extends";import _slicedToArray from"@babel/runtime-corejs3/helpers/slicedToArray";import React,{useState,useEffect,useMemo,useCallback,useContext}from"react";import isNil from"lodash/isNil";import get from"lodash/get";import set from"lodash/set";import cloneDeep from"lodash/cloneDeep";import noop from"lodash/noop";import isEqual from"lodash/isEqual";import cx from"classnames";import{TranslatorContext}from"@jutro/locale";import{warning}from"@jutro/logger";import{_ITEM_CHILDREN_,metadataTypes}from"@jutro/uimetadata";import{resolveTemplateUpdateMap,DYNAMIC_INDEX_REGEX}from"./resolveTemplateUpdateMap";import{injectId,injectData,injectChildren,injectValue}from"./injectionResolvers";import{MetadataContent}from"../metadataContent/MetadataContent";const DYNAMIC_INDEX_UPDATE_PATTERN=new RegExp(DYNAMIC_INDEX_REGEX.source,`${DYNAMIC_INDEX_REGEX.flags}g`);export const EmptyComponent=()=>null;export const getCodelessComponent=(displayName,metadataTypeConfig,propTypesConfig,content,contentLayout,usePassThroughDataHandling,wrapperTag)=>{const templateDefinition={content:content},templateUpdateMap=resolveTemplateUpdateMap(templateDefinition),hasDynamicTemplatePaths=Object.values(templateUpdateMap).some((paths=>paths.some((path=>DYNAMIC_INDEX_UPDATE_PATTERN.test(path)))));return instanceProps=>{var _propTypesConfig$chil;const instanceId=instanceProps.id,instanceClassName=instanceProps.className,instancePath=instanceProps.path,inputValue=instanceProps.value,onValueChange=instanceProps.onValueChange,inputData=instanceProps.data,onDataChange=instanceProps.onDataChange,children=instanceProps.children,contextualResolvers=instanceProps.resolvers,instanceChildren=useMemo((()=>null!=children?children:React.createElement(EmptyComponent,null)),[children]);null!==(_propTypesConfig$chil=propTypesConfig.children)&&void 0!==_propTypesConfig$chil&&_propTypesConfig$chil.required&&void 0===children&&warning(`${displayName}: The prop 'children' is marked as required but its value was not provided.`);const Tag=useMemo((()=>"script"===wrapperTag?(warning(`${displayName}: script is not allowed to be used as a custom tag. Falling back to 'div' instead.`),"div"):wrapperTag||"div"),[]),initialData=useMemo((()=>{let data;return metadataTypeConfig===metadataTypes.FIELD?data=inputValue:metadataTypeConfig===metadataTypes.CONTAINER&&(data=inputData),data||{}}),[inputValue,inputData]),_useState=useState(),_useState2=_slicedToArray(_useState,2),componentMetadata=_useState2[0],setComponentMetadata=_useState2[1],_useState3=useState(Object.entries(templateUpdateMap)),_useState4=_slicedToArray(_useState3,2),templateUpdatesMappings=_useState4[0],setTemplateUpdatesMappings=_useState4[1],_useState5=useState(instanceChildren),_useState6=_slicedToArray(_useState5,2),boundInstanceChildren=_useState6[0],setBoundInstanceChildren=_useState6[1],_useState7=useState(initialData),_useState8=_slicedToArray(_useState7,2),internalData=_useState8[0],setInternalData=_useState8[1],_useState9=useState(),_useState10=_slicedToArray(_useState9,2),wrapsContent=_useState10[0],setWrapsContent=_useState10[1],translator=useContext(TranslatorContext),resolvePath=useCallback((path=>instancePath?`${instancePath}.${path}`:path),[instancePath]),readValue=useCallback(((fieldId,path)=>{if(path)return get(internalData,path)}),[internalData]),passThroughDataUpdate=useCallback(((value,path)=>{metadataTypeConfig===metadataTypes.FIELD?inputValue&&set(inputValue,path,value):metadataTypeConfig===metadataTypes.CONTAINER&&inputData&&set(inputData,path,value)}),[inputValue,inputData]),onDataChangeCallback=useMemo((()=>{let callback;return metadataTypeConfig===metadataTypes.FIELD?callback=onValueChange:metadataTypeConfig===metadataTypes.CONTAINER&&(callback=onDataChange),callback||noop}),[onValueChange,onDataChange]),writeValue=useCallback(((value,path)=>{path&&setInternalData((currentData=>{const newData=cloneDeep(currentData);return set(newData,path,value),usePassThroughDataHandling?passThroughDataUpdate(value,path):onDataChangeCallback(value,resolvePath(path)),newData}))}),[passThroughDataUpdate,onDataChangeCallback,resolvePath]),getChildData=useCallback(((child,prop)=>{const path=child.props.path;return path?readValue(void 0,path):child.props[prop]}),[readValue]),instanceChildrenWithDataHandling=useMemo((()=>[metadataTypes.FIELD,metadataTypes.CONTAINER].some((dataHandlingType=>metadataTypeConfig===dataHandlingType))&&children?React.Children.map(instanceChildren,(child=>React.isValidElement(child)?React.cloneElement(child,{value:getChildData(child,"value"),data:getChildData(child,"data"),onValueChange:writeValue,onDataChange:writeValue}):child)):instanceChildren),[instanceChildren,getChildData,writeValue,children]),instanceChildrenCount=useMemo((()=>instanceChildrenWithDataHandling&&React.Children.count(instanceChildrenWithDataHandling)),[instanceChildrenWithDataHandling]),hasSingleRuntimeChild=useMemo((()=>{var _componentMetadata$co,_componentMetadata$co2;const rootContentNode=null==componentMetadata||null===(_componentMetadata$co=componentMetadata.content)||void 0===_componentMetadata$co?void 0:_componentMetadata$co[0],noneOrSingleRuntimeChildExpected=rootContentNode===`{${_ITEM_CHILDREN_}}`&&1===instanceChildrenCount,singleRuntimeChildProvided=1===instanceChildrenCount&&React.isValidElement(rootContentNode);return 1===(null==componentMetadata||null===(_componentMetadata$co2=componentMetadata.content)||void 0===_componentMetadata$co2?void 0:_componentMetadata$co2.length)&&(noneOrSingleRuntimeChildExpected||singleRuntimeChildProvided)}),[componentMetadata,instanceChildrenCount]);useEffect((()=>{if(componentMetadata&&isNil(wrapsContent)){var _componentMetadata$co3,_componentMetadata$co4;const rootNode=null==componentMetadata||null===(_componentMetadata$co3=componentMetadata.content)||void 0===_componentMetadata$co3?void 0:_componentMetadata$co3[0],hasSingleContentNode=hasSingleRuntimeChild||1===(null==componentMetadata||null===(_componentMetadata$co4=componentMetadata.content)||void 0===_componentMetadata$co4?void 0:_componentMetadata$co4.length)&&rootNode!==_ITEM_CHILDREN_&&!React.isValidElement(rootNode);isNil(wrapperTag)&&hasSingleContentNode?setWrapsContent(!1):setWrapsContent(!0)}}),[componentMetadata,wrapsContent,hasSingleRuntimeChild]),useEffect((()=>{instanceChildrenWithDataHandling&&children&&(isNil(wrapsContent)||wrapsContent||!hasSingleRuntimeChild?setBoundInstanceChildren(instanceChildrenWithDataHandling):setBoundInstanceChildren((()=>React.Children.map(instanceChildrenWithDataHandling,(child=>{var _child$props;return React.cloneElement(child,{id:instanceId,className:cx(null===(_child$props=child.props)||void 0===_child$props?void 0:_child$props.className,instanceClassName)})})))))}),[children,hasSingleRuntimeChild,instanceChildrenWithDataHandling,instanceClassName,instanceId,wrapsContent]),useEffect((()=>{hasDynamicTemplatePaths&&instanceChildrenCount&&setTemplateUpdatesMappings((currentTemplateUpdatesMappings=>{let dynamicTemplateUpdatesMappings=[...currentTemplateUpdatesMappings];return dynamicTemplateUpdatesMappings=dynamicTemplateUpdatesMappings.reduce(((res,[variable,paths])=>[...res,[variable,paths.map((path=>path.replace(DYNAMIC_INDEX_UPDATE_PATTERN,((match,matchedIndex)=>parseInt(matchedIndex,10)+instanceChildrenCount-1))))]]),[]),dynamicTemplateUpdatesMappings=dynamicTemplateUpdatesMappings.sort((aPair=>_slicedToArray(aPair,1)[0]===_ITEM_CHILDREN_?-1:0)),dynamicTemplateUpdatesMappings}))}),[children,instanceChildrenCount]),useEffect((()=>{const localTemplate=cloneDeep(templateDefinition);templateUpdatesMappings.forEach((([variable,paths])=>{const _map$filter=[injectId,injectData,injectChildren,injectValue].map((fn=>fn({template:localTemplate,props:{...instanceProps,children:boundInstanceChildren},variable:variable,dataContainer:internalData,translator:translator}))).filter(Boolean),resolveInjection=_slicedToArray(_map$filter,1)[0];resolveInjection&&paths.forEach((path=>{const _resolveInjection=resolveInjection(path),targetPath=_resolveInjection.path,value=_resolveInjection.value;targetPath&&set(localTemplate,targetPath,value)}))})),setComponentMetadata((metadata=>isEqual(metadata,localTemplate)?metadata:localTemplate))}),[boundInstanceChildren,instanceProps,internalData,templateUpdatesMappings,translator]),useEffect((()=>{isNil(wrapsContent)||wrapsContent||hasSingleRuntimeChild||setComponentMetadata((currentMetadata=>{const updatedMetadata=cloneDeep(currentMetadata);set(updatedMetadata,"content[0].id",instanceId);const currentClassName=get(updatedMetadata,"content[0].componentProps.className");return set(updatedMetadata,"content[0].componentProps.className",cx(currentClassName,instanceClassName)),updatedMetadata}))}),[wrapsContent,hasSingleRuntimeChild,instanceId,instanceClassName]);const overrideProps={"@field":{onValueChange:writeValue},"@container":{onDataChange:writeValue}},uiProps=useMemo((()=>({...componentMetadata,contentLayout:contentLayout})),[componentMetadata]),renderedContent=React.createElement(MetadataContent,_extends({uiProps:uiProps,overrideProps:overrideProps},contextualResolvers,{resolveValue:readValue}));return wrapsContent?React.createElement(Tag,{id:instanceId,className:instanceClassName},renderedContent):renderedContent}};