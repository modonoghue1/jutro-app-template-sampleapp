import _objectWithoutProperties from"@babel/runtime-corejs3/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime-corejs3/helpers/classCallCheck";import _createClass from"@babel/runtime-corejs3/helpers/createClass";import Ajv from"ajv";import merge from"lodash/merge";import get from"lodash/get";import replace from"lodash/replace";let JsonFormValidator=function(){function JsonFormValidator({dataSchemaExtension:dataSchemaExtension,options:options,ValidationService:ValidationService}={}){_classCallCheck(this,JsonFormValidator),this.validationService=ValidationService?new ValidationService({...options,allErrors:!0}):new Ajv({...options,allErrors:!0,extendRefs:!0}),this.validator=null,this.customMessages={},this.definitions={},this.dataSchemaExtension=dataSchemaExtension}return _createClass(JsonFormValidator,[{key:"validate",value:function(schema,data){return this.validator||(this.validator=this.validationService.compile(schema)),this.validator(data)}},{key:"errorMessagesByPath",value:function(){if(!this.validator||!this.validator.errors)return;const validationProps={};return this.validator.errors.forEach((error=>{let path=error.dataPath;"required"===error.keyword?path=`${path}.${error.params.missingProperty}`:"dependencies"===error.keyword?path=`${path}.${error.params.deps}`:"forbidden"===error.keyword&&(path=`${path}.${error.params.forbiddenProperty}`),path.startsWith(".")&&(path=path.substr(1));const message=this.getErrorMessage(error,path);validationProps[path]=[message]})),validationProps}},{key:"errorText",value:function(){if(this.validator&&this.validator.errors)return this.validationService.errorsText(this.validator.errors)}},{key:"dataProps",value:function(schema,data,resolveDataType,overrideDataProps={}){this.customMessages={},this.definitions=schema.definitions,this.components=schema.components;const dataProps={};this.processDataProps(schema,data,dataProps,resolveDataType||this.dataSchemaExtension);return merge(dataProps,overrideDataProps)}},{key:"findReference",value:function(ref){const refPath=ref.replace(/\//g,".").replace(/~1/g,"/");return refPath.startsWith("#.components.")?get(this.components,refPath.substr("#.components.".length)):get(this.definitions,refPath.substr("#.definitions.".length))}},{key:"resolveReference",value:function(schema){if(schema.$ref){const $ref=schema.$ref,schemaProps=_objectWithoutProperties(schema,["$ref"]),refProps=this.findReference($ref);if(refProps)return{...refProps,...schemaProps}}return schema}},{key:"getErrorMessage",value:function(error,path){let message=error.message;const resolvedPath=replace(path,/\[([0-9]+)\]/g,".*");const customMessages=this.customMessages[resolvedPath];return customMessages&&customMessages[error.keyword]&&(message=customMessages[error.keyword],error.params&&message.includes("{")&&(message=substituteMessageParams(message,error.params))),message}},{key:"getDataType",value:function(schemaItem,schemaItemProps,resolveDataType){const type=schemaItem.type,format=schemaItem.format;let datatype=type;const otherProps={};if(resolveDataType){const answer=resolveDataType(schemaItem,schemaItemProps);if(answer)return{datatype:datatype,processChildProperties:!1,...answer}}if("object"===type||"array"===type)return{datatype:datatype,otherProps:otherProps};if("string"===type&&"date"===format&&(datatype="date",otherProps.dataType="string"),"string"===type&&"date-time"===format&&(datatype="date",otherProps.dataType="date-time"),"string"===type&&schemaItem.enum){datatype="select";const enumValues=schemaItem.enum,enumNames=schemaItem.enumNames,availableValues=enumValues.map(((value,i)=>{const label=enumNames&&enumNames[i]||value.toString();return{code:value,name:label}}));otherProps.availableValues=availableValues,otherProps.dataType="string"}return{datatype:datatype,otherProps:otherProps}}},{key:"getIsRequired",value:function(key,required,dependencies,basePath,data){if(required&&required.includes(key))return!0;if(dependencies){return Object.keys(dependencies).filter((source=>Array.isArray(dependencies[source])&&dependencies[source].includes(key))).some((source=>void 0!==get(data,basePath?`${basePath}.${source}`:source)))}return!1}},{key:"processDataProps",value:function(schema,data,dataProps,resolveDataType,basePath,hiddenByDependency){if(!schema.properties&&!schema.$ref)return;const schemaRoot=this.resolveReference(schema);if(!schemaRoot.properties)return;const keys=Object.keys(schemaRoot.properties),required=schemaRoot.required,dependencies=schemaRoot.dependencies,schemaParentItem=(schemaRoot.properties,schemaRoot.definitions,_objectWithoutProperties(schemaRoot,["required","dependencies","properties","definitions"]));keys.forEach((key=>{const path=basePath?`${basePath}.${key}`:key,schemaItem=this.resolveReference(schemaRoot.properties[key]);if(schemaItem.oneOf)return void schemaItem.oneOf.forEach((oneOfItem=>{this.processDataProps(oneOfItem,data,dataProps,resolveDataType,path,hiddenByDependency)}));const title=schemaItem.title,maxLength=schemaItem.maxLength,messages=schemaItem.messages,_schemaItem$nullable=schemaItem.nullable,nullable=void 0===_schemaItem$nullable?schemaItem["x-gw-nullable"]:_schemaItem$nullable,readOnly=schemaItem.readOnly,dataPath=schemaRoot.properties[key].$ref,_this$getDataType=this.getDataType(schemaItem,{schemaParentItem:schemaParentItem,schemaItemKey:key,data:data||{},dataPath:dataPath||"",path:path},resolveDataType),datatype=_this$getDataType.datatype,component=_this$getDataType.component,_this$getDataType$oth=_this$getDataType.otherProps,otherProps=void 0===_this$getDataType$oth?{}:_this$getDataType$oth,_this$getDataType$pro=_this$getDataType.processChildProperties,processChildProperties=void 0===_this$getDataType$pro||_this$getDataType$pro,isRequired=this.getIsRequired(key,required,dependencies,basePath,data);if(readOnly&&(otherProps.readOnly=readOnly),maxLength&&(otherProps.maxLength=maxLength),nullable&&(otherProps.nullable=nullable),isRequired&&!hiddenByDependency&&(otherProps.schemaRequired=isRequired),hiddenByDependency&&(otherProps.visible=!1),messages&&(this.customMessages[path]=messages),dataProps[path]={componentProps:{...title?{label:title}:{},...otherProps}},datatype&&(dataProps[path].datatype=datatype),component&&(dataProps[path].component=component),processChildProperties){const schemaItemType=schemaItem.type;if("object"===schemaItemType)return void this.processDataProps(schemaItem,data,dataProps,resolveDataType,path,hiddenByDependency);if("array"===schemaItemType)return void this.processDataProps(schemaItem.items,data,dataProps,resolveDataType,`${path}.*`,hiddenByDependency)}if(dependencies&&dependencies[key]&&!Array.isArray(dependencies[key])){const keyValue=get(data,path);this.processDataProps(dependencies[key],data,dataProps,resolveDataType,basePath,hiddenByDependency||void 0===keyValue)}}))}}]),JsonFormValidator}();export{JsonFormValidator as default};export function substituteMessageParams(message,values){let newMessage=message;if(message&&values){Object.keys(values).forEach((key=>{newMessage=newMessage.replace(new RegExp(`{${key}}`,"g"),values[key])}))}return newMessage}