import _slicedToArray from"@babel/runtime-corejs3/helpers/slicedToArray";import _extends from"@babel/runtime-corejs3/helpers/extends";import React from"react";import pickBy from"lodash/pickBy";import mapValues from"lodash/mapValues";import last from"lodash/last";import cloneDeep from"lodash/cloneDeep";import set from"lodash/set";import{NavLink}from"react-router-dom";import{mountRouteComponent,TranslatorContextForTest}from"@jutro/test";import{GridLayout}from"@jutro/layout";import{ModalNextEmitter}from"@jutro/components";import{createBrowserHistory}from"history";import{simpleNamedComponentMap}from"../render/componentMap";const dangerouslySetInnerHTML={__html:"<div id='dangerous-div'></div>"},dangerousUrlRegExp=/^javascript:/,simpleComponentList=Object.values(simpleNamedComponentMap).map((({component:component})=>component)),wrappedComponentNameRegExp=/\w+\((\w+)\)/,propDefaultValueMap={Element:document.createElement("DIV"),RegExp:new RegExp,bool:!0,number:1,string:"string",object:{dangerouslySetInnerHTML:dangerouslySetInnerHTML},node:React.createElement("span",null),element:React.createElement("span",null),elementType:()=>React.createElement("span",null),func:()=>null,any:{dangerouslySetInnerHTML:dangerouslySetInnerHTML},Date:new Date,Promise:Promise.resolve(!0),objectOf:{dangerouslySetInnerHTML:dangerouslySetInnerHTML},Error:new Error("Custom error for XSS test"),ModalNextEmitter:new ModalNextEmitter},dataTableConfigColumnsSortedShape=[{id:"string",desc:!0}],customPropDefaultValueMap={dataTableConfigColumnsSortedShape:dataTableConfigColumnsSortedShape,dataTableConfigShape:{editedRow:0,columns:[],filterValue:"",page:0,pageSize:10,sorted:dataTableConfigColumnsSortedShape},elementsWithId:React.createElement("div",{id:"test-id"}),intlMessageShape:"string",historyPropTypes:createBrowserHistory(),intlToShape:"string",dataTypeShape:"string",actionShape:{label:"string",icon:"string",callback:()=>{}},toShape:"string",linkShape:{label:"string",onClick:()=>{},href:'javascript: alert("XSS");'},defaultAvailableValuePropType:"string",DateShape:{year:2e3,month:1,day:1,hour:12,minute:0},dateRangeValueShape:{startDate:{year:2e3,month:1,day:1,hour:12,minute:0},endDate:{year:2020,month:1,day:1,hour:12,minute:0}},dateTimeZoneValueShape:{datetime:{year:2e3,month:1,day:1,hour:12,minute:0},timezone:"Europe/London"},valuePropType:"string",availableValueObjectShape:{code:"string",dangerouslySetInnerHTML:dangerouslySetInnerHTML},routeShape:{dangerouslySetInnerHTML:dangerouslySetInnerHTML},solidColorPropTypes:{hexColor:"#fff",color:"white",dangerouslySetInnerHTML:dangerouslySetInnerHTML},LookupOptionShape:{id:"string",type:"string",dangerouslySetInnerHTML:dangerouslySetInnerHTML},sliderValuePropType:1,TypeaheadSingleValueShape:"string",tabShape:{id:"string"},layoutShape:{id:"string"},appSwitcherRoutePropTypes:{title:"string",to:"string",href:"string"},dropdownMenuLinkShape:{id:"string",to:"string"},dateValueShape:new Date("2018-08-30T12:00"),currencyValueShape:123.45,nestedTooltipShape:{id:"123",icon:"gw-bathtub",text:"informative tooltip",title:"informative tooltip",link:"localhost",href:"localhost",placement:"right"},gridItemOptionsShape:{rowSpan:"1",rowStart:"1",colSpan:"1",colStart:"1",textAlign:"left",valign:"top",align:"start"},rowIdShape:"string",columnsLayoutChildrenPropType:React.createElement(GridLayout,{id:"123"},React.createElement("div",{id:"test"})),columnsLayoutColumnsPropType:void 0,contextPropType:{title:"Title",path:"/",match:/\//},sizePropTypes:"string",contextShape:{path:"test"},routesShape:[],PhoneShape:{countryCode:{code:"PL"},phoneNumber:"600500400"},tooltipShape:{text:"string",placement:"top"}},jutroPropRegex=/(\w+)\(([^)]+)\)/,arrayRegex=/\[([^,]+)(,[^,]+)*]/,blacklistedProps=["onFetchData","helpPopoverItems","defaultCountry"];export function testAgainstXSS(components,loadSnapshot){describe("XSS",(()=>{components.forEach((Component=>{const componentName=getComponentName(Component);componentName||describe("components",(()=>{it("component should have a name",(()=>{expect(componentName).toBeDefined()}))})),describe(componentName,(()=>{const props=createProps(componentName,{components:components,loadSnapshot:loadSnapshot});beforeEach((()=>{window.IntersectionObserver=function(){return{observe:()=>{}}}})),it("should prevent dangerouslySetInnerHTML props of being set",(()=>{expect((()=>{const wrapper=mountInJutroEnvironment(React.createElement(Component,_extends({},props,{dangerouslySetInnerHTML:dangerouslySetInnerHTML})));expect(wrapper.find("#dangerous-div")).not.toExist()})).not.toThrow()})),["href","to","url"].forEach((dangerousProp=>{const paths=getPropPaths(props,dangerousProp);if(paths.length){const dangerousProps=cloneDeep(props);paths.forEach((path=>set(dangerousProps,path,'javascript: alert("XSS");'))),it(`should sanitize "${dangerousProp}" prop to prevent XSS`,(()=>{const wrapper=mountInJutroEnvironment(React.createElement(Component,dangerousProps));wrapper.find("a").forEach((anchor=>expect(anchor).toHaveProp("href",expect.not.stringMatching(dangerousUrlRegExp)))),wrapper.find("form").forEach((form=>expect(form).toHaveProp("action",expect.not.stringMatching(dangerousUrlRegExp)))),wrapper.find(NavLink).forEach((navLink=>expect(navLink).toHaveProp("to",expect.not.stringMatching(dangerousUrlRegExp))))}))}}))}))}))}))}function getComponentName(component){const componentName=component.displayName||component.name,match=wrappedComponentNameRegExp.exec(componentName);return match?match[1]:componentName}function createProps(componentName,context){const props=getComponentProps(componentName,context);return createShapeProp(mapValues(props,(({type:type,required:required,defaultValue:defaultValue})=>({...type,required:required,defaultValue:defaultValue}))),context)}function getComponentProps(componentPath,context){const _getComponentSnapshot=function(componentName,context){const snapshotFileName=`${componentName}_properties_snapshot.json5`;return context.loadSnapshot(snapshotFileName)}(last(componentPath.split("/")),context),_getComponentSnapshot2=_getComponentSnapshot.props,props=void 0===_getComponentSnapshot2?{}:_getComponentSnapshot2,_getComponentSnapshot3=_getComponentSnapshot.composes;return(void 0===_getComponentSnapshot3?[]:_getComponentSnapshot3).filter(isInternalComponent).map((path=>getComponentProps(path,context))).reduceRight(mergeProps,props)}function isInternalComponent(path){const fileNameStart=last(path.split("/")).charAt(0);return[".","/"].includes(path.charAt(0))&&fileNameStart===fileNameStart.toUpperCase()}function mergeProps(props,propsToAdd){return{...propsToAdd,...mapValues(props,((value,key)=>({...propsToAdd[key],...value})))}}function createShapeProp(props,context){const propsToCreate=pickBy(props,shouldBeCreated);return mapValues(propsToCreate,((prop,key)=>createPropByType(prop,{...context,key:key})))}function shouldBeCreated(value,key){return function({defaultValue:defaultValue}){return!defaultValue}(value)&&function(value,key){return!blacklistedProps.some((k=>k===key))}(0,key)}function createPropByType({name:name,value:value,raw:raw},context){switch(name){case"enum":return function({value:value}){return new Function(`return ${value};`)()}(value[0]);case"union":return createPropByType(value[0],{...context,key:`${context.key}.0`});case"array":return createPropByType({name:"arrayOf",value:{name:"any"}},context);case"arrayOf":return[createPropByType(value,{...context,key:`${context.key}.value`})];case"shape":return createShapeProp(value,context);case"custom":return createCustomProp(raw,context);case"instanceOf":if(value in propDefaultValueMap)return propDefaultValueMap[value];throw new Error(`Unable to create instance of unknown class "${value}" for prop "${context.key}"!`);default:if(name in propDefaultValueMap)return propDefaultValueMap[name];throw new Error(`Unknown prop type "${name}" for prop "${context.key}"!`)}}function createCustomProp(raw,context){if(raw.endsWith(".isRequired"))return createCustomProp(raw.slice(0,-11),context);if(raw.startsWith("ComponentPropTypes"))return createCustomJutroProp(raw.slice(19),context);if(raw in customPropDefaultValueMap)return customPropDefaultValueMap[raw];throw new Error(`Unknown custom prop type "${raw}"!`)}function createCustomJutroProp(raw,context){const _jutroPropRegex$exec=jutroPropRegex.exec(raw),_jutroPropRegex$exec2=_slicedToArray(_jutroPropRegex$exec,3),prop=_jutroPropRegex$exec2[1],value=_jutroPropRegex$exec2[2];switch(prop){case"childOfComponentType":return createComponentByName(value,context);case"oneOfChildOfComponentTypes":{const _arrayRegex$exec=arrayRegex.exec(value);return createComponentByName(_slicedToArray(_arrayRegex$exec,2)[1].trim(),context)}default:throw new Error(`Unknown custom jutro prop type "${prop}" with value "${value}" in "${raw}"!`)}}function createComponentByName(componentName,context){const Component=function(name,context){return context.components.concat(simpleComponentList).find((component=>getComponentName(component)===name))}(componentName,context),props=createProps(componentName,context);return React.createElement(Component,props)}function mountInJutroEnvironment(jsx){return mountRouteComponent(TranslatorContextForTest(jsx))}function getPropPaths(object,prop){return object&&"object"==typeof object?Array.isArray(object)?object.reduce(((paths,item,index)=>paths.concat(getPropPaths(item,prop).map((path=>`${index}.${path}`)))),[]):Object.entries(object).reduce(((paths,[key,value])=>paths.concat(getPropPaths(value,prop).map((path=>`${key}.${path}`)))),prop in object?[prop]:[]):[]}createPropByType.__docgenInfo={componentName:"createPropByType",packageName:"@jutro/uiconfig",description:"",displayName:"createPropByType",methods:[],actualName:"createPropByType"},createCustomProp.__docgenInfo={componentName:"createCustomProp",packageName:"@jutro/uiconfig",description:"",displayName:"createCustomProp",methods:[],actualName:"createCustomProp"},createCustomJutroProp.__docgenInfo={componentName:"createCustomJutroProp",packageName:"@jutro/uiconfig",description:"",displayName:"createCustomJutroProp",methods:[],actualName:"createCustomJutroProp"},createComponentByName.__docgenInfo={componentName:"createComponentByName",packageName:"@jutro/uiconfig",description:"",displayName:"createComponentByName",methods:[],actualName:"createComponentByName"};